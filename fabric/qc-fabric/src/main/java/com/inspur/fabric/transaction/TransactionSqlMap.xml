<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="TransactionDomain">
	<select id="getTransactionCount" parameterType="map" resultType="map">
		SELECT COUNT(TX_ID) VAL FROM CHAIN_TRANSACTIONS
		<where>
			<if test="CHANNEL_NAME != null and CHANNEL_NAME != ''">
				AND CHANNEL_NAME = #{CHANNEL_NAME}
			</if>
			<if test=" CHAINCODE_NAME!= null and CHANNEL_NAME != ''">
				AND CHAINCODE_NAME = #{CHAINCODE_NAME}
			</if>
			<if test="CREATOR_MSP!= null and CREATOR_MSP != ''">
				AND CREATOR_MSP = #{CREATOR_MSP}
			</if>
		</where>
	</select>
	<select id="getTransaction" parameterType="String" resultType="map">
		SELECT 
			ID, TX_ID, CHANNEL_NAME, BLOCK_NUM, 
			CHAINCODE_NAME, TX_KEY, TX_VALUE, CREATOR_MSP, END_COUNT,
		<choose>
		<when test="v6dbtype==mysql">
			DATE_FORMAT(TX_TIME, '%Y-%m-%d %H:%i:%s') CREATEDT
		</when>
		<otherwise>
			TO_CHAR(TX_TIME,'yyyy-mm-dd HH24:MI:SS') CREATEDT
		</otherwise>
		</choose>
		FROM chain_transactions
		WHERE ID=#{value}
	</select>
	
	<select id="getTranbyHash" parameterType="String" resultType="map">
		SELECT 
			ID, TX_ID, CHANNEL_NAME, BLOCK_NUM, 
			CHAINCODE_NAME, TX_KEY, TX_VALUE, CREATOR_MSP, END_COUNT,
			<choose>
			<when test="v6dbtype==mysql">
				DATE_FORMAT(TX_TIME, '%Y-%m-%d %H:%i:%s') CREATEDT
			</when>
			<otherwise>
				TO_CHAR(TX_TIME,'yyyy-mm-dd HH24:MI:SS') CREATEDT
			</otherwise>
			</choose>
		FROM chain_transactions
		WHERE TX_ID=#{value}
	</select>
	
	<select id="getAllTransactionPage" parameterType="map" resultType="map">
		SELECT 
			ID, TX_ID, CHANNEL_NAME, BLOCK_NUM, 
			CHAINCODE_NAME, TX_KEY, 
			CREATOR_MSP, END_COUNT,
			<choose>
			<when test="v6dbtype==mysql">
				DATE_FORMAT(TX_TIME, '%Y-%m-%d %H:%i:%s') CREATEDT
			</when>
			<otherwise>
				TO_CHAR(TX_TIME,'yyyy-mm-dd HH24:MI:SS') CREATEDT
			</otherwise>
			</choose>
		FROM chain_transactions
		<where>
			<if test="CHANNEL_NAME != null and CHANNEL_NAME != ''">
				AND CHANNEL_NAME = #{CHANNEL_NAME}
			</if>
			<if test=" CHAINCODE_NAME!= null and CHANNEL_NAME != ''">
				AND CHAINCODE_NAME = #{CHAINCODE_NAME}
			</if>
			<if test="CREATOR_MSP!= null and CREATOR_MSP != ''">
				AND CREATOR_MSP = #{CREATOR_MSP}
			</if>
		</where>
		ORDER BY ID DESC
	</select>
	
	<select id="getTransactionTopPage" parameterType="map" resultType="map">
		SELECT COUNT(id) val ,DATE_FORMAT(TX_TIME,'%Y-%m-%d %H:%i:%s') DATETIME
		FROM CHAIN_TRANSACTIONS
		<where>
			<if test="CHANNEL_NAME != null and CHANNEL_NAME != ''">
				AND CHANNEL_NAME = #{CHANNEL_NAME}
			</if>
			<if test=" CHAINCODE_NAME!= null and CHANNEL_NAME != ''">
				AND CHAINCODE_NAME = #{CHAINCODE_NAME}
			</if>
			<if test="CREATOR_MSP!= null and CREATOR_MSP != ''">
				AND CREATOR_MSP = #{CREATOR_MSP}
			</if>
		</where>
		GROUP BY DATE_FORMAT(TX_TIME,'%Y-%m-%d %H:%i:%s')
		ORDER BY val DESC
	</select>
	
<!--
	<select id="getTransaction" parameterType="String" resultType="map">
		SELECT
			ID,
			CHANNELNAME,
			BLOCKID,
			TXHASH,
			<choose>
			<when test="v6dbtype==mysql">
				DATE_FORMAT(CREATEDT, '%Y-%m-%d %H:%i:%s') CREATEDT,
			</when>
			<otherwise>
				TO_CHAR(CREATEDT,'yyyy-mm-dd HH24:MI:SS') CREATEDT,
			</otherwise>
			</choose>
			CHAINCODENAME
		FROM transaction
		WHERE ID=#{value}
	</select>
	<select id="getTranbyHash" parameterType="String" resultType="map">
		SELECT
			ID,
			CHANNELNAME,
			BLOCKID,
			TXHASH,
			<choose>
			<when test="v6dbtype==mysql">
				DATE_FORMAT(CREATEDT, '%Y-%m-%d %H:%i:%s') CREATEDT,
			</when>
			<otherwise>
				TO_CHAR(CREATEDT,'yyyy-mm-dd HH24:MI:SS') CREATEDT,
			</otherwise>
			</choose>
			CHAINCODENAME
		FROM transaction
		WHERE TXHASH=#{value}
	</select>

	<insert id="insertTransaction" parameterType="map">
		INSERT INTO transaction(
			ID,
			CHANNELNAME,
			BLOCKID,
			TXHASH,
			CREATEDT,
			CHAINCODENAME
		) VALUES (
			#{ID,jdbcType=VARCHAR},
			#{CHANNELNAME,jdbcType=VARCHAR},
			#{BLOCKID,jdbcType=VARCHAR},
			#{TXHASH,jdbcType=VARCHAR},
			#{CREATEDT,jdbcType=VARCHAR},
			#{CHAINCODENAME,jdbcType=VARCHAR}
		)
	</insert>

	<update id="updateTransaction" parameterType="map">
		UPDATE transaction SET
			CHANNELNAME = #{CHANNELNAME,jdbcType=VARCHAR},
			BLOCKID = #{BLOCKID,jdbcType=VARCHAR},
			TXHASH = #{TXHASH,jdbcType=VARCHAR},
			CREATEDT = #{CREATEDT,jdbcType=VARCHAR},
			CHAINCODENAME = #{CHAINCODENAME,jdbcType=VARCHAR}
		WHERE ID=#{ID}
	</update>
	
	<delete id="deleteTransaction" parameterType="String">
		DELETE FROM transaction WHERE ID=#{value}
	</delete>

	<select id="getAllTransactionPage" parameterType="map" resultType="map">
		SELECT
			ID,
			CHANNELNAME,
			BLOCKID,
			TXHASH,
			<choose>
			<when test="v6dbtype==mysql">
				DATE_FORMAT(CREATEDT, '%Y-%m-%d %H:%i:%s') CREATEDT,
			</when>
			<otherwise>
				TO_CHAR(CREATEDT,'yyyy-mm-dd HH24:MI:SS') CREATEDT,
			</otherwise>
			</choose>
			CHAINCODENAME
		FROM transaction
		<where>
			<if test="idSearch != null and idSearch != ''">
				AND ID = #{idSearch}
			</if>
			<if test="channelnameSearch != null and channelnameSearch != ''">
				AND CHANNELNAME = #{channelnameSearch}
			</if>
			<if test="blockidSearch != null and blockidSearch != ''">
				AND BLOCKID = #{blockidSearch}
			</if>
			<if test="txhashSearch != null and txhashSearch != ''">
				AND TXHASH = #{txhashSearch}
			</if>
			<if test="createdtSearch != null and createdtSearch != ''">
				AND CREATEDT = #{createdtSearch}
			</if>
			<if test="chaincodenameSearch != null and chaincodenameSearch != ''">
				AND CHAINCODENAME = #{chaincodenameSearch}
			</if>
		</where>
		ORDER BY ID DESC
	</select>
	-->
</mapper>
